# GitHub Actions å‘å¸ƒå·¥ä½œæµé…ç½®
# ç”¨äºè‡ªåŠ¨åŒ–å‘å¸ƒæµç¨‹ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬æ›´æ–°ã€æ–‡æ¡£ç”Ÿæˆå’Œå‘å¸ƒåˆ° crates.io

name: å‘å¸ƒ

on:
  push:
    tags:
      - "v*"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force_release:
        description: "å¼ºåˆ¶å‘å¸ƒï¼ˆä»…ç”¨äºæµ‹è¯•ï¼‰"
        required: true
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  check_stage:
    name: æ£€æŸ¥å‘å¸ƒé˜¶æ®µ
    runs-on: ubuntu-latest
    outputs:
      can_release: ${{ steps.check.outputs.can_release }}

    steps:
      - name: æ£€æŸ¥æ˜¯å¦å…è®¸å‘å¸ƒ
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && "${{ github.event.inputs.force_release }}" == "true" ]]; then
            echo "can_release=true" >> $GITHUB_OUTPUT
            echo "å…è®¸æµ‹è¯•å‘å¸ƒ"
          else
            echo "can_release=false" >> $GITHUB_OUTPUT
            echo "å½“å‰å¤„äºæµ‹è¯•é˜¶æ®µï¼Œæš‚åœå‘å¸ƒ"
            echo "å¦‚éœ€æµ‹è¯•å‘å¸ƒæµç¨‹ï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è§¦å‘å¹¶è®¾ç½® force_release=true"
          fi

  release:
    name: å‘å¸ƒ
    needs: check_stage
    if: needs.check_stage.outputs.can_release == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: å®‰è£… Rust å·¥å…·é“¾
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: ç¼“å­˜ä¾èµ–
        uses: Swatinem/rust-cache@v2

      - name: éªŒè¯ Cargo.toml
        run: cargo check --manifest-path Cargo.toml

      - name: è¿è¡Œæµ‹è¯•
        run: cargo test --all-features

      - name: æ„å»ºæ–‡æ¡£
        run: cargo doc --no-deps --document-private-items

      - name: å‡†å¤‡å‘å¸ƒ
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "RELEASE_NOTES=$(cat CHANGELOG.md | sed -n "/^## \[$VERSION\]/,/^## \[/p" | sed '$d')" >> $GITHUB_ENV
          echo "IS_TEST_RELEASE=true" >> $GITHUB_ENV

      - name: å‘å¸ƒåˆ° crates.io
        if: github.event_name == 'workflow_dispatch' # æµ‹è¯•é˜¶æ®µåªå…è®¸æ‰‹åŠ¨å‘å¸ƒ
        run: cargo publish --token ${{ secrets.CRATES_IO_TOKEN }}

      - name: åˆ›å»º GitHub å‘å¸ƒ
        uses: softprops/action-gh-release@v1
        with:
          name: v${{ env.RELEASE_VERSION }} (æµ‹è¯•ç‰ˆ)
          body: |
            ${{ env.RELEASE_NOTES }}

            > âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬ï¼Œä¸å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚
          draft: true # æµ‹è¯•é˜¶æ®µé»˜è®¤åˆ›å»ºè‰ç¨¿
          prerelease: true # æ ‡è®°ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          files: |
            target/doc/**/*

      - name: æ›´æ–°å¼€å‘åˆ†æ”¯
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'github-actions@github.com'
          git checkout -b develop
          git merge --no-ff $GITHUB_REF -m "chore: åˆå¹¶æµ‹è¯•ç‰ˆæœ¬ ${{ env.RELEASE_VERSION }}"
          git push origin develop

      - name: åˆ›å»ºé‡Œç¨‹ç¢‘
        uses: softprops/action-gh-release@v1
        with:
          tag_name: milestone-${{ env.RELEASE_VERSION }}
          name: æµ‹è¯•é‡Œç¨‹ç¢‘ v${{ env.RELEASE_VERSION }}
          body: |
            ## æµ‹è¯•åŠŸèƒ½
            ${{ env.RELEASE_NOTES }}

            ## æµ‹è¯•è®¡åˆ’
            - [ ] æ”¶é›†æµ‹è¯•åé¦ˆ
            - [ ] ä¿®å¤å‘ç°çš„é—®é¢˜
            - [ ] å®Œå–„æ–‡æ¡£
            - [ ] å‡†å¤‡æ­£å¼å‘å¸ƒ
          draft: true
          prerelease: true

  notify:
    name: é€šçŸ¥
    needs: [check_stage, release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: å‘é€æµ‹è¯•å‘å¸ƒé€šçŸ¥
        if: success() && needs.check_stage.outputs.can_release == 'true'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            ğŸ§ª FlowBuilder æµ‹è¯•ç‰ˆæœ¬ ${{ github.ref_name }} å·²åˆ›å»º
            ğŸ“¦ ä¸‹è½½: https://crates.io/crates/flowbuilder
            ğŸ“š æ–‡æ¡£: https://docs.rs/flowbuilder
            âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç‰ˆæœ¬
            ğŸ”„ æ›´æ–°æ—¥å¿—: https://github.com/ThneS/flowbuilder/blob/main/CHANGELOG.md

      - name: å‘é€å‘å¸ƒè¢«é˜»æ­¢é€šçŸ¥
        if: success() && needs.check_stage.outputs.can_release == 'false'
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            â¸ï¸ FlowBuilder å‘å¸ƒè¢«é˜»æ­¢
            â„¹ï¸ åŸå› ï¼šå½“å‰å¤„äºæµ‹è¯•é˜¶æ®µ
            ğŸ“ å¦‚éœ€æµ‹è¯•å‘å¸ƒï¼Œè¯·ä½¿ç”¨æ‰‹åŠ¨è§¦å‘å¹¶è®¾ç½® force_release=true

      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: failure()
        uses: Ilshidur/action-discord@master
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          args: |
            âŒ FlowBuilder å‘å¸ƒå¤±è´¥
            ğŸ” æŸ¥çœ‹è¯¦æƒ…: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
